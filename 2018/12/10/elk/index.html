<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Elastic Stack 入门 | 雨碎江南</title><meta name="author" content="consoles"><meta name="copyright" content="consoles"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="常见术语 Document：存储在ES中的一些数据，存储的最小单元。表中的一行数据。是JSON object，由field组成，有数据类型，每一个文档有唯一id，拥有meta data标注文档(_source,_id等)的相关信息。 Index:具有相同结构的文档的集合。对应表。拥有自己的mapping定义，定义字段名和类型。一个集群可以有多个索引，例如nginx日志可以按照每天生成一个索引来存储">
<meta property="og:type" content="article">
<meta property="og:title" content="Elastic Stack 入门">
<meta property="og:url" content="https://consoles.fun/2018/12/10/elk/index.html">
<meta property="og:site_name" content="雨碎江南">
<meta property="og:description" content="常见术语 Document：存储在ES中的一些数据，存储的最小单元。表中的一行数据。是JSON object，由field组成，有数据类型，每一个文档有唯一id，拥有meta data标注文档(_source,_id等)的相关信息。 Index:具有相同结构的文档的集合。对应表。拥有自己的mapping定义，定义字段名和类型。一个集群可以有多个索引，例如nginx日志可以按照每天生成一个索引来存储">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://consoles.fun/img/butterfly-icon.png">
<meta property="article:published_time" content="2018-12-10T21:04:11.000Z">
<meta property="article:modified_time" content="2025-04-06T15:01:37.000Z">
<meta property="article:author" content="consoles">
<meta property="article:tag" content="大数据">
<meta property="article:tag" content="数据分析">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://consoles.fun/img/butterfly-icon.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Elastic Stack 入门",
  "url": "https://consoles.fun/2018/12/10/elk/",
  "image": "https://consoles.fun/img/butterfly-icon.png",
  "datePublished": "2018-12-10T21:04:11.000Z",
  "dateModified": "2025-04-06T15:01:37.000Z",
  "author": [
    {
      "@type": "Person",
      "name": "consoles",
      "url": "https://consoles.fun/"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://consoles.fun/2018/12/10/elk/index.html"><link rel="preconnect" href="//cdnjs.cloudflare.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/node-snackbar/0.1.16/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.36/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!true && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"已切换为繁体中文","cht_to_chs":"已切换为简体中文","day_to_night":"已切换为深色模式","night_to_day":"已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  infinitegrid: {
    js: 'https://cdnjs.cloudflare.com/ajax/libs/egjs-infinitegrid/4.12.0/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: true,
  isAnchor: true,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Elastic Stack 入门',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><script>window.paceOptions = {
  restartOnPushState: false
}

btf.addGlobalFn('pjaxSend', () => {
  Pace.restart()
}, 'pace_restart')

</script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-minimal.min.css"/><script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js"></script><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">雨碎江南</span></a><a class="nav-page-title" href="/"><span class="site-name">Elastic Stack 入门</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">Elastic Stack 入门</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2018-12-10T21:04:11.000Z" title="发表于 2018-12-10 21:04:11">2018-12-10</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-04-06T15:01:37.000Z" title="更新于 2025-04-06 15:01:37">2025-04-06</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/">后端开发</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><article class="container post-content" id="article-container"><h1 id="常见术语"><a href="#常见术语" class="headerlink" title="常见术语"></a>常见术语</h1><ul>
<li>Document：存储在ES中的一些数据，存储的最小单元。表中的一行数据。是JSON object，由field组成，有数据类型，每一个文档有唯一id，拥有meta data标注文档(<code>_source</code>,<code>_id</code>等)的相关信息。</li>
<li>Index:具有相同结构的文档的集合。对应表。拥有自己的mapping定义，定义字段名和类型。一个集群可以有多个索引，例如nginx日志可以按照每天生成一个索引来存储。</li>
<li>Node：一个es的运行实例，是构成集群的基本单元</li>
<li>Cluster：由一个或者多个节点组成，对外提供服务</li>
</ul>
<h1 id="反向索引和分词"><a href="#反向索引和分词" class="headerlink" title="反向索引和分词"></a>反向索引和分词</h1><ul>
<li>正排索引：文档id到文档内容、单词的关联关系</li>
<li>反向索引：单词到文档id的关联关系</li>
</ul>
<p>查询流程，通过关键字从反向索引中找到文档id，然后通过文档id使用正排索引返回所有符合条件的文档。</p>
<p>反向索引是搜索引擎的核心，主要包含2部分：</p>
<ul>
<li>单词词典（Term Dictionary）：记录文档所有单词和单词到倒排列表的关联信息，一般比较大。实现方式一般是B+树</li>
<li>倒排列表（Posting List）：包含文档id，单词词频（Term Frequency，用于后续相关性算分），位置（position，记录单词在文档中分词的位置，可以是多个，用于做词语搜索Phrase Query），偏移（Offset，记录单词在文档开始和结束的位置，用于做高亮显示）</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-cdn-bmnleumcou.cn-shenzhen.fcapp.run/?a=images/elasticsearch_term_dict_impl.png" alt="使用B+树实现单词字典"></p>
<p>B+树好处：插入和查询性能高，更高效利用磁盘和内存的映射机制。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-cdn-bmnleumcou.cn-shenzhen.fcapp.run/?a=images/term_dict_posting_list.png" alt="单词词典和反向索引"></p>
<p>例如：search 搜索引擎的时候通过term dictionary快速在b+树中定位到搜索引擎，拿到在postion list中的偏移量，从而得到反向索引项的docid 1和3</p>
<p>es中分词称为文本分析analysis.自带分词器有standard&#x2F;simple,whitespace,stop,keyword,pattern,language.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">POST</span> _analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;standard&quot;</span>,</span><br><span class="line">  <span class="string">&quot;text&quot;</span>: <span class="string">&quot;hello world!&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;tokens&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;hello&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;world&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">11</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>自定义分词器，其实是自定义分词器的3个组成部分：Character Filters,Tokenizer和Token Filter实现。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">POST</span> _analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;standard&quot;</span>, </span><br><span class="line">  <span class="string">&quot;filter&quot;</span>: [<span class="string">&quot;lowercase&quot;</span>], </span><br><span class="line">  <span class="string">&quot;text&quot;</span>: <span class="string">&quot;Hello World!&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;tokens&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;hello&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;world&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">11</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="中文分词的难点"><a href="#中文分词的难点" class="headerlink" title="中文分词的难点"></a>中文分词的难点</h2><ul>
<li>英文可以使用空格作为自然分界符，但是中文没有一个形式上的分界符。</li>
<li>上下文不同，分词结果迥异，例如交叉歧义问题，例如下面的两种分词结果其实都是合理的：</li>
<li>乒乓球拍&#x2F;卖&#x2F;完了</li>
<li>乒乓球&#x2F;拍卖&#x2F;完了</li>
</ul>
<p>常用的中文分词系统有IK和jieba。更高阶的则是基于NLP的分词系统，例如Hanlp，THULAC.  </p>
<h1 id="Mapping设置"><a href="#Mapping设置" class="headerlink" title="Mapping设置"></a>Mapping设置</h1><p>类似DB中表结构的定义，主要作用：</p>
<ul>
<li>定义index下的字段名（field name）</li>
<li>定义字段类型，例如Number，Text，Boolean</li>
<li>定义反向索引相关的配置，例如是否索引，记录position等</li>
</ul>
<p>自定义mapping和dynamic的效果</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line">PUT test_index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;doc&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;dynamic&quot;</span>:<span class="literal">false</span>,</span><br><span class="line">      <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;title&quot;</span>:&#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;name&quot;</span>:&#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;age&quot;</span>:&#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;integer&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET test_index/_mapping</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;test_index&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;doc&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;dynamic&quot;</span>: <span class="string">&quot;false&quot;</span>,</span><br><span class="line">        <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;age&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;type&quot;</span>: <span class="string">&quot;integer&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">&quot;name&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">&quot;title&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT test_index/doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;title&quot;</span>:<span class="string">&quot;hello world&quot;</span>,</span><br><span class="line">  <span class="string">&quot;desc&quot;</span>:<span class="string">&quot;nothing exist.&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询title可以返回结果</span></span><br><span class="line">GET test_index/doc/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;title&quot;</span>: <span class="string">&quot;hello&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;took&quot;</span>: 84,</span><br><span class="line">  <span class="string">&quot;timed_out&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="string">&quot;_shards&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;total&quot;</span>: 5,</span><br><span class="line">    <span class="string">&quot;successful&quot;</span>: 5,</span><br><span class="line">    <span class="string">&quot;skipped&quot;</span>: 0,</span><br><span class="line">    <span class="string">&quot;failed&quot;</span>: 0</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;hits&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;total&quot;</span>: 1,</span><br><span class="line">    <span class="string">&quot;max_score&quot;</span>: 0.2876821,</span><br><span class="line">    <span class="string">&quot;hits&quot;</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;_index&quot;</span>: <span class="string">&quot;test_index&quot;</span>,</span><br><span class="line">        <span class="string">&quot;_type&quot;</span>: <span class="string">&quot;doc&quot;</span>,</span><br><span class="line">        <span class="string">&quot;_id&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;_score&quot;</span>: 0.2876821,</span><br><span class="line">        <span class="string">&quot;_source&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;title&quot;</span>: <span class="string">&quot;hello world&quot;</span>,</span><br><span class="line">          <span class="string">&quot;desc&quot;</span>: <span class="string">&quot;nothing exist.&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询desc得不到结果</span></span><br><span class="line">GET test_index/doc/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;desc&quot;</span>: <span class="string">&quot;no&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>copy_to，将该字段的值复制到目标字段，实现类似_all的作用，一般不会出现在_source中，只用来搜索。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;doc&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;first_name&quot;</span>:&#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">          <span class="string">&quot;copy_to&quot;</span>: <span class="string">&quot;full_name&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;last_name&quot;</span>:&#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">          <span class="string">&quot;copy_to&quot;</span>: <span class="string">&quot;full_name&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;full_name&quot;</span>:&#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT my_index/doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;first_name&quot;</span>:<span class="string">&quot;张&quot;</span>,</span><br><span class="line">  <span class="string">&quot;last_name&quot;</span>:<span class="string">&quot;三丰&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET my_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;full_name&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;query&quot;</span>: <span class="string">&quot;张三丰&quot;</span>,</span><br><span class="line">        <span class="string">&quot;operator&quot;</span>: <span class="string">&quot;and&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;took&quot;</span>: 117,</span><br><span class="line">  <span class="string">&quot;timed_out&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="string">&quot;_shards&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;total&quot;</span>: 5,</span><br><span class="line">    <span class="string">&quot;successful&quot;</span>: 5,</span><br><span class="line">    <span class="string">&quot;skipped&quot;</span>: 0,</span><br><span class="line">    <span class="string">&quot;failed&quot;</span>: 0</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;hits&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;total&quot;</span>: 1,</span><br><span class="line">    <span class="string">&quot;max_score&quot;</span>: 0.8630463,</span><br><span class="line">    <span class="string">&quot;hits&quot;</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;_index&quot;</span>: <span class="string">&quot;my_index&quot;</span>,</span><br><span class="line">        <span class="string">&quot;_type&quot;</span>: <span class="string">&quot;doc&quot;</span>,</span><br><span class="line">        <span class="string">&quot;_id&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;_score&quot;</span>: 0.8630463,</span><br><span class="line">        <span class="string">&quot;_source&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;first_name&quot;</span>: <span class="string">&quot;张&quot;</span>,</span><br><span class="line">          <span class="string">&quot;last_name&quot;</span>: <span class="string">&quot;三丰&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>index字段控制当前字段是否索引，默认为true，如果设置为false则不可搜索。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;doc&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;cookie&quot;</span>:&#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">          <span class="string">&quot;index&quot;</span>: <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT my_index/doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;cookie&quot;</span>:<span class="string">&quot;name=root&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET my_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;cookie&quot;</span>: <span class="string">&quot;name&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 查询将会报错 Cannot search on field [cookie] since it is not indexed.</span></span><br></pre></td></tr></table></figure>

<p>索引设置为false的情形主要用于一些敏感信息，例如身份证号、手机号,index_options用于控制反向索引记录的内容。</p>
<p>dynamic templates：es默认会为字符串设置text类型，并增加一个keyword子字段。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">PUT test_index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;doc&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;dynamic_templates&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;strings_as_keywords&quot;</span>:&#123;</span><br><span class="line">            <span class="string">&quot;match_mapping_type&quot;</span>:<span class="string">&quot;string&quot;</span>,</span><br><span class="line">            <span class="string">&quot;mapping&quot;</span>:&#123;</span><br><span class="line">              <span class="string">&quot;type&quot;</span>:<span class="string">&quot;keyword&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;    </span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT test_index/doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;name&quot;</span>:<span class="string">&quot;hello&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET test_index/_mapping</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;test_index&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;doc&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;dynamic_templates&quot;</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="string">&quot;strings_as_keywords&quot;</span>: &#123;</span><br><span class="line">              <span class="string">&quot;match_mapping_type&quot;</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">              <span class="string">&quot;mapping&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;name&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>字段名匹配：以message开头的字段都设置为text类型</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">注意：2个dynamic_templates匹配顺序从上到下，只要匹配一个就结束了</span><br><span class="line">PUT test_index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;doc&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;dynamic_templates&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;message_as_text&quot;</span>:&#123;</span><br><span class="line">            <span class="string">&quot;match_mapping_type&quot;</span>:<span class="string">&quot;string&quot;</span>,</span><br><span class="line">            <span class="string">&quot;match&quot;</span>:<span class="string">&quot;message*&quot;</span>,</span><br><span class="line">            <span class="string">&quot;mapping&quot;</span>:&#123;</span><br><span class="line">              <span class="string">&quot;type&quot;</span>:<span class="string">&quot;text&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;strings_as_keywords&quot;</span>:&#123;</span><br><span class="line">            <span class="string">&quot;match_mapping_type&quot;</span>:<span class="string">&quot;string&quot;</span>,</span><br><span class="line">            <span class="string">&quot;mapping&quot;</span>:&#123;</span><br><span class="line">              <span class="string">&quot;type&quot;</span>:<span class="string">&quot;keyword&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;    </span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT test_index/doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;name&quot;</span>:<span class="string">&quot;hello world&quot;</span>,</span><br><span class="line">  <span class="string">&quot;message&quot;</span>:<span class="string">&quot;today is suny&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET test_index/_mapping</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;test_index&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;doc&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;dynamic_templates&quot;</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="string">&quot;message_as_text&quot;</span>: &#123;</span><br><span class="line">              <span class="string">&quot;match&quot;</span>: <span class="string">&quot;message*&quot;</span>,</span><br><span class="line">              <span class="string">&quot;match_mapping_type&quot;</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">              <span class="string">&quot;mapping&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="string">&quot;strings_as_keywords&quot;</span>: &#123;</span><br><span class="line">              <span class="string">&quot;match_mapping_type&quot;</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">              <span class="string">&quot;mapping&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;message&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">&quot;name&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>自定义mapping的操作步骤如下：</p>
<ol>
<li>写入一条文档到es的临时索引中，获取es自动生成的mapping</li>
<li>修改步骤1得到的mapping，自定义相关设置</li>
<li>使用步骤2的mapping创建实际所需索引</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">DELETE test_index</span><br><span class="line">PUT test_index/doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;referrer&quot;</span>:<span class="string">&quot;-&quot;</span>,</span><br><span class="line">  <span class="string">&quot;response_code&quot;</span>:200,</span><br><span class="line">  <span class="string">&quot;remote_ip&quot;</span>:<span class="string">&quot;189,90,89,00&quot;</span>,</span><br><span class="line">  <span class="string">&quot;method&quot;</span>:<span class="string">&quot;POST&quot;</span>,</span><br><span class="line">  <span class="string">&quot;username&quot;</span>:<span class="string">&quot;-&quot;</span>,</span><br><span class="line">  <span class="string">&quot;http_version&quot;</span>:<span class="string">&quot;1.1&quot;</span>,</span><br><span class="line">  <span class="string">&quot;body_sent&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;bytes&quot;</span>:0</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;url&quot;</span>:<span class="string">&quot;/stat&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET test_index/_mapping</span><br><span class="line">拷贝上面的结果然后根据自己的需要进行适当修改即可</span><br></pre></td></tr></table></figure>

<p>可以使用dynamic_templates将所有字段设置为keyword不分词，只将自己需要的字段按照合适的类型进行单独定义。灵活使用这个技术可以减少设置mapping的工作量。</p>
<p>index template，用于新建索引的时候自动应用预定的设置，简化创建索引的步骤。</p>
<h1 id="Search-API"><a href="#Search-API" class="headerlink" title="Search API"></a>Search API</h1><p>endpoint为<code>_search</code>，调用如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GET _search</span><br><span class="line">GET my_index/_search</span><br><span class="line">GET my_index,test_index/_search</span><br><span class="line">GET my_*/_search</span><br></pre></td></tr></table></figure>

<p>查询有两种形式URI(仅包含部分语法)和request body（基于完整的query dsl）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET /my_index/_search?q=username:tom</span><br><span class="line"></span><br><span class="line">GET /my_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;term&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;username&quot;</span>:<span class="string">&quot;tom&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="URI-Search"><a href="#URI-Search" class="headerlink" title="URI Search"></a>URI Search</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GET my_index/_seach?q=tom&amp;<span class="built_in">df</span>=username&amp;<span class="built_in">sort</span>=age:asc&amp;from=4&amp;size=10&amp;<span class="built_in">timeout</span>=1s</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;profile&quot;</span>:<span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>es提供了查询profile可以进行查询调优。</p>
<p>注意：term查询，phrase查询和泛查询</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET my_index/_search?q=username:tom black <span class="comment"># tom为查询username，而black会查询所有字段</span></span><br><span class="line">GET my_index/_search?q=username:<span class="string">&quot;tom black&quot;</span> <span class="comment"># 查询username完全匹配tom black</span></span><br><span class="line">GET my_index/_search?q=username:(tom black) <span class="comment"># group query，查询username=tom或者username=black</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># + 和 -分别表示must和must not</span></span><br><span class="line">GET my_index/_search?q=username:(tom NOT black) <span class="comment"># username 包含tom不包含black</span></span><br><span class="line">GET my_index/_search?q=username:(tom +black) <span class="comment"># username 一定有black，包含tom的文档，注意urisearch的时候加号要替换成%2B</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 范围查询</span></span><br><span class="line">GET my_index/_search?q=username:tom and age:&gt;20 <span class="comment"># username包含tom并且age&gt;20</span></span><br></pre></td></tr></table></figure>

<p>通配符查询执行效率低，并且吃内存，不建议使用，千万不要放在最前面可能导致OOM。</p>
<p>模糊匹配(fuzzy)：<code>roam~1</code>，foam、roams都会匹配<br>近似度查询(proximity):<code>&quot;fox quick&quot;~5</code>，以term为单位进行差异比较，<code>quick fox</code>,<code>quick brown fox</code>都会匹配<br>一般用于用户输入的纠错。</p>
<h2 id="Query-DSL"><a href="#Query-DSL" class="headerlink" title="Query DSL"></a>Query DSL</h2><h3 id="Match-Query"><a href="#Match-Query" class="headerlink" title="Match Query"></a>Match Query</h3><p>会进行分词处理。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-cdn-bmnleumcou.cn-shenzhen.fcapp.run/?a=images/match_query.png" alt="match query的流程"></p>
<p>通过operator参数可以控制match中单词的匹配关系，可选值<code>and</code>,<code>or</code>（默认）<br>minimum_should_match参数可以控制需要匹配的单词数</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">GET test_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;explain&quot;</span>:<span class="literal">true</span>,</span><br><span class="line">  <span class="string">&quot;query&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;username&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;query&quot;</span>:<span class="string">&quot;jack tom&quot;</span>,</span><br><span class="line">        <span class="string">&quot;operator&quot;</span>:<span class="string">&quot;and&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>5.x之后默认的相关性算分基于BM25,是针对TF-IDF模型的一个优化。BM(Best Match)，迭代25次。一个大的优化是降低了TF在过大的时候的权重，我们可以使用explain参数查看详细的算分过程。</p>
<p>match_phase则将query看做一个完整的词语，强调顺序，可以使用<code>slop</code>实现和proximity相似的效果。<br>query_string类似于search uri中q参数的查询。</p>
<h3 id="Term-Terms-Query"><a href="#Term-Terms-Query" class="headerlink" title="Term &amp; Terms Query"></a>Term &amp; Terms Query</h3><p>不对查询语句进行分词处理。</p>
<p>注意</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET test_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;term&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;username&quot;</span>:<span class="string">&quot;jack tom&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上查询将不会返回结果，因为构建反向索引的时候会分词，反向索引中不存在”jack tom”这个词语。</p>
<h3 id="Range-Query"><a href="#Range-Query" class="headerlink" title="Range Query"></a>Range Query</h3><p>针对数值和日期，gt，gte，lt，lte。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET test_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;range&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;age&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;gte&quot;</span>:10,</span><br><span class="line">        <span class="string">&quot;lt&quot;</span>:20</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>针对日期提供了一种更友好的方式Date Math，可以实现类似“最近一个小时”的查询</p>
<p>now - 1d</p>
<p><code>now</code>为基准日期，可以是具体的时间（使用双竖线隔离），例如2018-01-01<br><code>-1d</code>为计算公式 <code>+1h</code>表示加一个小时 <code>/d</code>表示将时间舍入到天</p>
<h3 id="Bool-Query"><a href="#Bool-Query" class="headerlink" title="Bool Query"></a>Bool Query</h3><p>Filter查询只过滤符合条件的文档，不计算相关性得分，es针对filter有智能缓存，因此执行效率很高。做简单匹配且不考虑分数的时候，推荐使用filter代替query。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">GET test_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;bool&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;filter&quot;</span>:&#123;</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;term&quot;</span>:&#123;</span><br><span class="line">            <span class="string">&quot;username&quot;</span>:<span class="string">&quot;admin&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="分布式特性"><a href="#分布式特性" class="headerlink" title="分布式特性"></a>分布式特性</h1><p><a target="_blank" rel="noopener" href="https://github.com/lmenezes/cerebro">cerebro</a>是一个便捷的针对es集群的web管理工具。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./bin/elasticsearch -Ecluster.name=my_cluster -Enode.name=node1 -Epath.data=my_cluster_node1 -Ehttp.port=5200 -d</span><br><span class="line">./bin/elasticsearch -Ecluster.name=my_cluster -Enode.name=node2 -Epath.data=my_cluster_node2 -Ehttp.port=5300 -d</span><br><span class="line">./bin/elasticsearch -Ecluster.name=my_cluster -Enode.name=node3 -Epath.data=my_cluster_node3 -Ehttp.port=5400 -d</span><br></pre></td></tr></table></figure>

<ul>
<li>可以修改cluster state的节点称为master节点，一个集群只能有一个，由集群中所有节点选举产生，可以被选举的节点称为master-eligible节点，相关配置<code>node.master:true</code>。</li>
<li>处理请求的节点称为coordinating节点，该节点为所有节点的默认您角色，不能取消。</li>
<li>路由请求到正确的节点处理，例如创建索引的请求到master节点。</li>
<li>存储数据的节点称为data节点，默认节点都是data类型，相关配置<code>node.data:true</code></li>
</ul>
<h2 id="副本和分片"><a href="#副本和分片" class="headerlink" title="副本和分片"></a>副本和分片</h2><p>引入分片（Shard）机制可以将数据均匀分布到所有节点上，从而充分利用集群的存储资源，是ES能够存储PB级别数据的基石。分片数在索引创建的时候指定，<em>后续不可修改</em>，默认为5。分片分为主分片和副本分片，实现数据高可用。副本分片由主分片负责同步，可以有多个，从而提高读取的吞吐量。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-cdn-bmnleumcou.cn-shenzhen.fcapp.run/?a=images/es-shard.png" alt="ES分片和副本"></p>
<p>注意：如果磁盘空间不足的时候es不会分片,参考集群设置<code>cluster.routing.allocation.disk.threshold_enabled</code>。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-cdn-bmnleumcou.cn-shenzhen.fcapp.run/?a=images/es-shard-replication.png" alt="分片"></p>
<p>上面图中实线是主分片，虚线是副本分片。分片数的设定非常重要，需要提前规划好。过小会导致后续无法通过增加节点实现水平扩容；过大会导致一个节点上分布过多分片，造成资源浪费，同时影响查询性能。</p>
<h2 id="Cluster-Health-故障转移"><a href="#Cluster-Health-故障转移" class="headerlink" title="Cluster Health &amp; 故障转移"></a>Cluster Health &amp; 故障转移</h2><p>green：所有主副分片都正常分配<br>yellow：所有主分片正常分配，但是又副本分片未正常分配<br>red：有主分片未分配</p>
<p>GET _cluster&#x2F;health</p>
<p>注意：即使集群处于RED状态，并不意味着集群不能提供服务。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 找到node1所在pid并kill</span></span><br><span class="line">ps aux | grep -i elasticsearc | grep node1</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-cdn-bmnleumcou.cn-shenzhen.fcapp.run/?a=images/elk-cluster_yellow.jpg" alt="node1挂掉之后集群变成了yellow"><br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-cdn-bmnleumcou.cn-shenzhen.fcapp.run/?a=images/elk-cluster_green.jpg" alt="经过一段时间集群重新生成副本变成了green"></p>
<h2 id="文档分布式存储"><a href="#文档分布式存储" class="headerlink" title="文档分布式存储"></a>文档分布式存储</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-cdn-bmnleumcou.cn-shenzhen.fcapp.run/?a=images/document_shard.png" alt="文档分片存储"></p>
<p>document 1是如何存储在分片P1上，这取决于文档到分片的映射算法，目的：文档均匀分布在所有分片上，充分利用资源。</p>
<p>随机选择或者round-robin算法是不可取的，因为文档存储进去之后还需要读取，需要维护文档到分片的映射关系，成本巨大。es采取的做法是根据文档实时算出其所在的分片。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shard = <span class="built_in">hash</span>(routing) % number_of_primary_shards</span><br></pre></td></tr></table></figure>

<p>hash算法可以保证数据分布，routing默认为文档id。该算法和主分片数相关，因此这也是<em>分片数一旦确定之后就不可更改</em>的原因。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-cdn-bmnleumcou.cn-shenzhen.fcapp.run/?a=images/process_of_create_document.png" alt="文档创建流程"><br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-cdn-bmnleumcou.cn-shenzhen.fcapp.run/?a=images/elk-process_of_document_read.jpg" alt="文档读取流程"></p>
<h2 id="脑裂问题"><a href="#脑裂问题" class="headerlink" title="脑裂问题"></a>脑裂问题</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-cdn-bmnleumcou.cn-shenzhen.fcapp.run/?a=images/elk-split_brain.jpg" alt="脑裂问题"><br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-cdn-bmnleumcou.cn-shenzhen.fcapp.run/?a=images/elk-split_brain_solve.jpg" alt="加入选举法定人数quorum避免脑裂问题"></p>
<p><em>小技巧</em> :生产环境中设置master-eligible为3，quorum为2即可。</p>
<h1 id="ES运行机制"><a href="#ES运行机制" class="headerlink" title="ES运行机制"></a>ES运行机制</h1><h2 id="Query-Then-Fetch"><a href="#Query-Then-Fetch" class="headerlink" title="Query Then Fetch"></a>Query Then Fetch</h2><h2 id="相关性算分"><a href="#相关性算分" class="headerlink" title="相关性算分"></a>相关性算分</h2><p>相关性算分在shard和shard之间是独立的（一个shard是一个Lucene Index，是一个完整的相关性算分的单位。），也就意味着同一Term的IDF等值在不同shard上是不同的。文档的相关性算分和它所处的shard相关<br>当文档数量不够多的时候会导致相关性算分严重不准的情况发生。</p>
<p>解决思路有2个：</p>
<ul>
<li>分片数设置为1。可以从根本上解决问题，在文档数量不多的时候可以考虑（百万、千万）</li>
<li>DFS Query then Fetch。拿到所有文档后重新进行一次相关性算分，耗费更多CPU和内存，性能低，不建议使用。</li>
</ul>
<h2 id="分页和遍历"><a href="#分页和遍历" class="headerlink" title="分页和遍历"></a>分页和遍历</h2><p>from&#x2F;size是最常用的分页解决方案。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-cdn-bmnleumcou.cn-shenzhen.fcapp.run/?a=images/deep-paging.png" alt="深度分页"></p>
<p>深度分页是所有的分布式搜索引擎和分布式系统都会遇到的问题,例如使用google搜索，调整url中的start</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">对不起，Google 为所有查询的结果数都不会超过 1000 个。 (您所请求的结果在第 28000000 个之后。)</span><br></pre></td></tr></table></figure>

<p>scroll提供了遍历文档集的API，以快照的方式来避免深度分页的问题。</p>
<ul>
<li>不能用来做实时搜索，因为数据不是实时的</li>
<li>尽量不要使用复杂的sort条件，使用<code>_doc</code>最高效</li>
<li>使用稍微复杂</li>
<li>过多的scroll调用会占用大量内存，可以使用clear api删除过多快照</li>
</ul>
<p>search_after避免了深度分页的性能问题，提供了实时的下一页文档的获取功能。</p>
<ul>
<li>不能使用from参数，即：不能指定页数</li>
<li>只能下一页，不能上一页</li>
<li>使用简单</li>
</ul>
<p>应用场景</p>
<ul>
<li>from&#x2F;size:需要实时获取顶部分不分文档，且需要自由翻页</li>
<li>scroll：需要全部文档，例如导出所有数据</li>
<li>search_after:需要全部文档，不需要自由翻页</li>
</ul>
<h1 id="聚合分析"><a href="#聚合分析" class="headerlink" title="聚合分析"></a>聚合分析</h1><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-cdn-bmnleumcou.cn-shenzhen.fcapp.run/?a=images/es-aggression.png" alt="ES聚合分析示例"></p>
<p>聚合分析分为以下4类：</p>
<ul>
<li>Bucket:类似SQL中的GROUP BY</li>
<li>Metric：计算最大值、最小值、平均值等</li>
<li>Pipeline：基于上一级的聚合分析结果再次进行分析</li>
<li>Matrix：矩阵分析类型</li>
</ul>
<p>所有的Kibana图表都是基于ES的Aggression实现的。</p>
<h2 id="Bucket聚合"><a href="#Bucket聚合" class="headerlink" title="Bucket聚合"></a>Bucket聚合</h2><p>按照一定的规则将分档分配到不同的桶中，达到分类分析的目的。</p>
<ul>
<li>terms：直接按照terms来分桶，如果是text类型，则按照分词后的结果进行分桶</li>
<li>ranges：通过指定数值范围来设定分桶规则</li>
<li>historgram:直方图。以固定间隔的策略来分割数据</li>
</ul>
<h2 id="Metric聚合"><a href="#Metric聚合" class="headerlink" title="Metric聚合"></a>Metric聚合</h2><ul>
<li>Cardinality意思是集合的势或者基数，是指不同集合的个数，类似SQL中的distinct count的概念。</li>
<li>使用stats可以一次性返回min,max,count,avg,sum。</li>
<li>extends_stats是对stats的拓展，包含了方差、标准差等。</li>
<li>percentile可以实现百分位数的统计。可以查看数据分布，例如：95%的请求在200ms内返回这样的需求。</li>
<li>top hits一般用于分桶后获取该桶内最匹配的顶部文档列表，即详情数据。</li>
</ul>
<h2 id="Bucket和Metric聚合分析"><a href="#Bucket和Metric聚合分析" class="headerlink" title="Bucket和Metric聚合分析"></a>Bucket和Metric聚合分析</h2><p>Bucket聚合分析允许通过添加子分析来进行进一步分析，该子分析可以是Bucket也可以是Metric。这也使得es的聚合分析能力变得异常强大。</p>
<h2 id="作用范围"><a href="#作用范围" class="headerlink" title="作用范围"></a>作用范围</h2><p>es默认作用范围是<em>query</em>的结果集，可以通过以下的方式改变其作用范围：</p>
<ul>
<li>filter</li>
<li>post_filter</li>
<li>global</li>
</ul>
<h2 id="排序以及精准度"><a href="#排序以及精准度" class="headerlink" title="排序以及精准度"></a>排序以及精准度</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-cdn-bmnleumcou.cn-shenzhen.fcapp.run/?a=images/terms-miss-percision.png" alt="ES Terms排序可能是不准的"></p>
<p>不准确的原因在于数据分散在多个Shard上，Coordinating Node无法得悉数据全貌。解决方案：</p>
<ol>
<li>设置Shard数为1，可以消除数据分散的问题，但是无法承载大数据量</li>
<li>合理设置Shard_Size的大小，即每次从Shard上额外多获取数据，以提升准确度</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-cdn-bmnleumcou.cn-shenzhen.fcapp.run/?a=images/balance.png" alt="数据规模&amp;准确度&amp;实时性的均衡"></p>
<p>ES的聚合分析中Cardinality和Percentile分析使用的是近似统计算法。</p>
<h1 id="数据建模"><a href="#数据建模" class="headerlink" title="数据建模"></a>数据建模</h1><p>一个博客文章的索引可以设置如下：</p>
<p>&#x2F;&#x2F; bash<br>{<br>  “mappings”:{<br>    “doc”:{<br>      “source”:{<br>        “enabled”:false<br>      },<br>      “properties”:{<br>        “title”:{<br>          “type”:”text”,<br>          “fields”:{<br>            “keyword”:{<br>              “type”:”keyword”<br>            }<br>          },<br>          “store”:true<br>        },<br>        “publish_date”:{<br>          “type”:”date”,<br>          “store”:true<br>        },<br>        “author”:{<br>          “type”:”keyword”,<br>          “store”:true<br>        },<br>        “abstract”:{<br>          “type”:”text”,<br>          “store”:true<br>        },<br>        “url”:{<br>          “doc_values”:false,<br>          “norms”:false,<br>          “ignore_above”:100<br>          “store”:true<br>        }<br>      }<br>    }<br>  }<br>}</p>
<p>由于文章内容可能非常大，所以关掉_source避免取过大的原始文档，为每个字段加了<code>store</code>属性专门存储字段原始值</p>
<ul>
<li>文章标题是需要进行全文检索和分词的，所以设置为text，keyword子字段可以对博客的标题进行完全匹配</li>
<li>url只需要做展示并不需要搜索</li>
</ul>
<h2 id="关联关系处理"><a href="#关联关系处理" class="headerlink" title="关联关系处理"></a>关联关系处理</h2><p>ES不擅长处理RDBMS中的外键，可以通过Nested Object或者Parent&#x2F;Child（Join数据类型）变相解决。其中使用Nested Object适用于查询频繁的场景，而Parent&#x2F;Child父子文档独立更新，为了维护join关系需要占用部分内存并且读取性能差。</p>
<h2 id="Reindex"><a href="#Reindex" class="headerlink" title="Reindex"></a>Reindex</h2><p>重建所有数据的过程，一般发生在如下的情况：</p>
<ul>
<li>mapping设置变更，例如字段类型变化、分词器字典更新等</li>
<li>index设置变更，例如分片数目更改</li>
<li>迁移数据</li>
</ul>
<p>es提供了<code>_update_by_query</code>(在现有索引上重建)和<code>_reindex</code>（将source中的数据重建到dest中）。数据重建的时间受源索引文档规模的影响，当规模越大的时候所需要的时间越多，此时需要设定url参数<code>wait_for_completion</code>为false启动异步任务来执行，可以通过<code>_task</code>来查看任务的执行进度和相关数据</p>
<h1 id="集群调优"><a href="#集群调优" class="headerlink" title="集群调优"></a>集群调优</h1><h2 id="JVM设定"><a href="#JVM设定" class="headerlink" title="JVM设定"></a>JVM设定</h2><p>JVM内存的设定不要超过31GB，预留一般内存给OS，用来做文件缓存。具体大小根据node存储的数据量来估算，为了保证性能，在内存和数据量之间有一个建议的比例：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-cdn-bmnleumcou.cn-shenzhen.fcapp.run/?a=images/es-jvm-memory.png" alt="JVM内存的设定"></p>
<h2 id="写性能优化"><a href="#写性能优化" class="headerlink" title="写性能优化"></a>写性能优化</h2><p>es写数据存在3个过程：</p>
<ol>
<li>refresh:segment写入磁盘的过程非常耗时，可以借助fs缓存的特性先将segment在缓存中创建并开放查询来进一步提升实时性。在refresh之前文档会先存储在一个buffer中，refresh时将buffer中的所有文档清空并猩猩segment。es默认每秒执行一次refresh，这也是es被称为Near Real Time的原因。</li>
<li>translog：用来避免segment还没有写入磁盘的时候发生了宕机。写入文档到buffer的同时将该操作写入translog。translog会即时写入磁盘(fsync)。es启动会检查translog并从中恢复数据。</li>
<li>flush：将内存中的segment落盘，主要做如下工作：将translog写入磁盘；将index buffer清空，其中的文档生成一个新的segment，相当于一个refresh操作；更新commit point并写入磁盘；执行fsync操作将内存中的segment落盘；删除旧的translog文件。</li>
</ol>
<p>写性能优化的目标是增大EPS(Events Per Second),优化方案：</p>
<ul>
<li>客户端：多线程写，批量写</li>
<li>ES：在高质量数据建模的前提下，主要是在refresh，translog和flush之间做文章</li>
</ul>
<p>调优参数:<code>refresh_interval</code>,<code>indices.memory.index_buffer_size</code>，<code>index.translog.durability</code>,<code>index.translog.sync_interval</code>,<code>index.translog.flush_threshold_size</code>。</p>
<h2 id="读性能优化"><a href="#读性能优化" class="headerlink" title="读性能优化"></a>读性能优化</h2><ul>
<li>尽量使用filter上下文，减少算分的场景，由于filter有缓存机制，可以极大提高查询性能</li>
<li>尽量不使用script进行字段计算或者算分排序</li>
<li>结合profile、explain api分析慢查询语句，然后优化数据模型</li>
</ul>
<h2 id="如何设定Shard数"><a href="#如何设定Shard数" class="headerlink" title="如何设定Shard数"></a>如何设定Shard数</h2><p>es的性能基本是线性拓展的，例如单个Shard的eps是1W，而线上eps要求是5W，则需要5个Shard（实际还需要考虑副本）。测试一个shard的流程如下：</p>
<ol>
<li>搭建和生产环境相同配置的单节点集群</li>
<li>设定一个单分片零副本的索引</li>
<li>写入实际生产数据进行测试，获得写性能指标</li>
<li>针对数据进行查询请求，获取读性能指标</li>
</ol>
<p>压测工具可以使用esrally，x-pack插件可以对es进行监控</p>
<h1 id="LogStash"><a href="#LogStash" class="headerlink" title="LogStash"></a>LogStash</h1><h2 id="入门-运行机制"><a href="#入门-运行机制" class="headerlink" title="入门 &amp; 运行机制"></a>入门 &amp; 运行机制</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-cdn-bmnleumcou.cn-shenzhen.fcapp.run/?a=images/logstash-process.png" alt="LogStash流程"><br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-cdn-bmnleumcou.cn-shenzhen.fcapp.run/?a=images/logstash-arch.png" alt="LogStash架构"></p>
<blockquote>
<p>可以使用<code>-r</code>命令行参数启动LogStash，可以热重载配置，便于调试。</p>
</blockquote>
<h2 id="线程分析"><a href="#线程分析" class="headerlink" title="线程分析"></a>线程分析</h2><p>LogStash使用不同的线程处理输入、过滤和输出：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-cdn-bmnleumcou.cn-shenzhen.fcapp.run/?a=images/24b88683-bbdc-4493-8164-b9220f2f1a19.png" alt="LogStash线程"></p>
<p>可以先使用<code>jps -ml</code>命令获得logstash的pid，再使用<code>top -H -p pid</code>查看线程信息。</p>
<h3 id="Queue"><a href="#Queue" class="headerlink" title="Queue"></a>Queue</h3><p>LogStash的Queue分为2种:</p>
<ul>
<li>In Memory:无法处理宕机</li>
<li>Persistent Queue In Disk:保证不丢失数据；保证数据至少消费一次；充当缓冲区，可以替代Kafka</li>
</ul>
<p>相比内存中的队列，PQ的EPS下降不是特别严重（5%以内），相关配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">queue.type:persisted</span><br><span class="line">queue.max_bytes:4gb</span><br></pre></td></tr></table></figure>

<h3 id="线程"><a href="#线程" class="headerlink" title="线程"></a>线程</h3><ul>
<li>每个Input Thread对应一个线程(Input-&gt;Codec)</li>
<li>每个pipeline worker Thread对应一个线程(Batcher-&gt;Filter-&gt;Output)</li>
</ul>
<p>相关配置有<code>pipeline.workers</code>,<code>pipeline.batch.size</code>,<code>pipeline.batch.delay</code>。</p>
<blockquote>
<p>线程查看工具可以使用visual vm。</p>
</blockquote>
<h2 id="插件"><a href="#插件" class="headerlink" title="插件"></a>插件</h2><h3 id="Input"><a href="#Input" class="headerlink" title="Input"></a>Input</h3><p>file插件用于从文件读取数据。</p>
<ul>
<li>通过sincedb解决重启LS时从上次读取的位置开始读取</li>
<li>定时检查文件是否更新读取文件的新内容</li>
<li>定时检查新文件来发现新文件</li>
<li>如果文件发生了rotation操作，则被rotation的文件可以继续被读取（基于inode，和文件名没有关系）</li>
<li>基于Filewatch的ruby库实现</li>
</ul>
<p>调试小技巧：sincedb_path设置为&#x2F;dev&#x2F;null，start_position何止为beginning可以每次从头读取文件。</p>
<p>codec主要负责将数据在原始与Logstash Event之间转换。 multiline可以匹配多行，藏剑的用途是提取错误堆栈信息。</p>
<h3 id="Filter"><a href="#Filter" class="headerlink" title="Filter"></a>Filter</h3><p>对Logstash Event进行转换解析，常用：date,<a target="_blank" rel="noopener" href="https://github.com/logstash-plugins/logstash-patterns-core/blob/master/patterns/grok-patterns">grok常用正则</a>,dissect基于分隔符解析数据，解决grok消耗过多CPU的问题。</p>
<p>dissect常用配置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># / 后面的指定匹配的顺序</span></span><br><span class="line">原始日志：two three one go</span><br><span class="line">配置： %&#123;+order/2&#125; %&#123;+order/3&#125; %&#123;+order/1&#125; %&#123;+order/4&#125;</span><br><span class="line">结果：&#123;<span class="string">&quot;order&quot;</span>:<span class="string">&quot;one two three go&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 动态的键值对(例如query参数)</span></span><br><span class="line">原始日志：a=1&amp;b=2</span><br><span class="line">配置：%&#123;?key1&#125;=%&#123;&amp;key1&#125;&amp;%&#123;?key2&#125;=%&#123;&amp;key2&#125;</span><br><span class="line">结果：&#123;<span class="string">&quot;a&quot;</span>:<span class="string">&quot;1&quot;</span>,<span class="string">&quot;b&quot;</span>:<span class="string">&quot;2&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<p>mutate是使用最频繁的插件，可以对字段进行各种操作：重命名、删除、替换、更新等。常用操作:convert类型转换，gsub字符串替换，split&#x2F;join&#x2F;merge，字符串切割&#x2F;数组合并，rename字段重命名，update&#x2F;replace字段内容更新或者替换，remove_field删除字段。</p>
<h3 id="调试配置建议"><a href="#调试配置建议" class="headerlink" title="调试配置建议"></a>调试配置建议</h3><p>使用http做input方便输入测试数据，并且可以结合reload特性(stdin无法reload)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">input &#123;http&#123;port =&gt; 7474&#125;&#125;</span><br><span class="line">filter &#123;&#125;</span><br><span class="line">output &#123;stdout&#123;codec =&gt; rubydebug&#125;&#125;</span><br></pre></td></tr></table></figure>

<p><code>@metadata</code>特殊字段其内部不会输出到output中，适合用来存储做条件判断、临时存储的字段，相比<code>remove_field</code>有一定的性能提升。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">input &#123;http&#123;port =&gt; 7474&#125;&#125;</span><br><span class="line">filter &#123;</span><br><span class="line">  <span class="comment"># 这里相当于一个调试开关</span></span><br><span class="line">  mutate &#123; add_field =&gt; &#123;<span class="string">&quot;[@metadata][debug]&quot;</span> =&gt; <span class="literal">true</span>&#125; &#125;</span><br><span class="line">  mutate &#123; add_field =&gt; &#123;<span class="string">&quot;show&quot;</span> =&gt; <span class="string">&quot;this data will in output&quot;</span>&#125; &#125;</span><br><span class="line">&#125;</span><br><span class="line">output &#123;</span><br><span class="line">  <span class="keyword">if</span> [@metadata][debug] &#123;</span><br><span class="line">    stdout &#123;codec =&gt; rubydebug&#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    stdout &#123;codec =&gt; dots&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="实战apache日志"><a href="#实战apache日志" class="headerlink" title="实战apache日志"></a>实战apache日志</h2><p>debug.conf</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">input &#123;http&#123;port =&gt; 7474&#125;&#125;</span><br><span class="line">filter &#123;</span><br><span class="line">  grok &#123;</span><br><span class="line">    match =&gt; &#123;</span><br><span class="line">      <span class="string">&quot;message&quot;</span> =&gt; <span class="string">&quot;%&#123;COMBINEDAPACHELOG&#125;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  mutate &#123;</span><br><span class="line">    remove_field =&gt; [<span class="string">&quot;headers&quot;</span>,<span class="string">&quot;message&quot;</span>,<span class="string">&quot;timestamp&quot;</span>]</span><br><span class="line">  &#125;</span><br><span class="line">  ruby &#123;</span><br><span class="line">    code =&gt; <span class="string">&quot;event.set(&#x27;@read_timestamp&#x27;,event.get(&#x27;@timestamp&#x27;))&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">  geoip &#123;</span><br><span class="line">    <span class="built_in">source</span> =&gt; <span class="string">&quot;clientip&quot;</span></span><br><span class="line">    fields =&gt; [<span class="string">&quot;location&quot;</span>,<span class="string">&quot;country_name&quot;</span>,<span class="string">&quot;city_name&quot;</span>,<span class="string">&quot;region_name&quot;</span>]</span><br><span class="line">  &#125;</span><br><span class="line">  useragent &#123;</span><br><span class="line">    <span class="built_in">source</span> =&gt; <span class="string">&quot;agent&quot;</span></span><br><span class="line">    target =&gt; <span class="string">&quot;useragent&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">date</span> &#123;</span><br><span class="line">    match =&gt; [<span class="string">&quot;timestamp&quot;</span>,<span class="string">&quot;dd/MMM/yyyy:HH:mm:ss Z&quot;</span>]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">output &#123;stdout&#123;codec =&gt; rubydebug&#125;&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/logstash -f debug.conf -r <span class="comment"># 使用-r参数可以热重载配置</span></span><br></pre></td></tr></table></figure>

<p>使用POSTMAN发送HTTP请求,注意将请求内容放在body中:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">218.19.140.242 - - [10/Dec/2010:09:31:17 +0800] <span class="string">&quot;GET /query/trendxml/district/todayreturn/month/2009-12-14/2010-12-09/haizhu_tianhe.xml HTTP/1.1&quot;</span> 200 1933 <span class="string">&quot;-&quot;</span> <span class="string">&quot;Mozilla/5.0 (Windows; U; Windows NT 5.1; zh-CN; rv:1.9.2.8) Gecko/20100722 Firefox/3.6.8 (.NET CLR 3.5.30729)&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="实战CSV文件"><a href="#实战CSV文件" class="headerlink" title="实战CSV文件"></a>实战CSV文件</h2><p>csv.conf</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">  file &#123;</span><br><span class="line">    path =&gt; <span class="string">&quot;/tmp/player_data.csv&quot;</span></span><br><span class="line">    start_position =&gt; <span class="string">&quot;beginning&quot;</span></span><br><span class="line">    sincedb_path =&gt; <span class="string">&quot;/dev/null&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">filter &#123;</span><br><span class="line">  csv &#123;</span><br><span class="line">    autodetect_column_names =&gt; <span class="literal">true</span></span><br><span class="line">    autogenerate_column_names =&gt; <span class="literal">false</span></span><br><span class="line">    convert =&gt; &#123;</span><br><span class="line">      <span class="string">&quot;uid&quot;</span> =&gt; <span class="string">&quot;integer&quot;</span></span><br><span class="line">      <span class="string">&quot;play_count&quot;</span> =&gt; <span class="string">&quot;integer&quot;</span></span><br><span class="line">      <span class="string">&quot;hundred_win_rate&quot;</span> =&gt; <span class="string">&quot;float&quot;</span></span><br><span class="line">      <span class="string">&quot;landlord_count&quot;</span> =&gt; <span class="string">&quot;integer&quot;</span></span><br><span class="line">      <span class="string">&quot;farmer_count&quot;</span> =&gt; <span class="string">&quot;integer&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  mutate &#123;</span><br><span class="line">    add_field =&gt; &#123;<span class="string">&quot;role_count&quot;</span> =&gt; <span class="string">&quot;%&#123;landlord_count&#125;,%&#123;farmer_count&#125;&quot;</span>&#125;</span><br><span class="line">    remove_field =&gt; [<span class="string">&quot;landlord_count&quot;</span>,<span class="string">&quot;farmer_count&quot;</span>,<span class="string">&quot;message&quot;</span>]</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">date</span> &#123;</span><br><span class="line">    match =&gt; [<span class="string">&quot;last_play_time&quot;</span>,<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">output &#123;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">      index =&gt; <span class="string">&quot;player_data&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    stdout &#123;codec =&gt; rubydebug&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>player_data.csv:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">uid,play_count,max_rate,win_count,win_max,win_max_time,<span class="string">&quot;last_play_time&quot;</span>,<span class="string">&quot;hundred_results&quot;</span>,hundred_win_rate,max_keep_win_count,win_max_rate,win_total,lose_total,spring_count,bomb_count,win_point,tnmt_count,tnmt_win_count,tnmt_best_rank,landlord_count,farmer_count,play_time,diamond_play_count</span><br><span class="line">9682421,504,73728,247,460800,1534842968,<span class="string">&quot;2018-10-24 14:33:48&quot;</span>,<span class="string">&quot;1111111000001110010010111011111001011101001100001110100000010010110111011101111110000010000100101001&quot;</span>,0.52,3,24576,3855191,5083567,5,348,0,0,0,99999,219,285,29220,0</span><br><span class="line">9682423,15,6912,5,2832,1531899522,<span class="string">&quot;2018-07-18 15:53:12&quot;</span>,<span class="string">&quot;110001101000000&quot;</span>,0.33,2,3072,9971,18879,NULL,26,0,0,0,99999,0,0,0,0</span><br><span class="line">9682424,1447,6144,795,4822,1536214982,<span class="string">&quot;2018-12-14 11:11:14&quot;</span>,<span class="string">&quot;0001111010100001100011110000001110100101100001010111111010011010000101111100101100000010110011001101&quot;</span>,0.48,9,4608,10230,393207,NULL,15,0,32,20,1,3,11,132,0</span><br></pre></td></tr></table></figure>

<h1 id="Beats"><a href="#Beats" class="headerlink" title="Beats"></a>Beats</h1><h2 id="Filebeat"><a href="#Filebeat" class="headerlink" title="Filebeat"></a>Filebeat</h2><p>读取日志文件，但是不做数据处理，保证”At least once”至少被读取一次，数据不会丢（但某些情况下数据可能被重复消费）。可以处理多行数据、解析JSON、简单的过滤功能。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-cdn-bmnleumcou.cn-shenzhen.fcapp.run/?a=images/filebeats-arch.png" alt="FileBeats架构"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -e输出到stderr，默认输出到syslog和logs/filebeat</span></span><br><span class="line"><span class="comment"># 由于6.x之后只能指定一个output，所以加上publish参数指定相关的debug日志</span></span><br><span class="line">filebeat -e -c filebeat.yml -d <span class="string">&quot;publish&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="Elasticsearch-Ingest-Node"><a href="#Elasticsearch-Ingest-Node" class="headerlink" title="Elasticsearch Ingest Node"></a>Elasticsearch Ingest Node</h3><p>5.x新增的一个节点类型，可以在数据写入ES之前(bulk&#x2F;index操作)对数据进行处理，可以配置独立的ingest node,(<code>node.ingest:true</code>)专门进行数据处理。api endpoint为pipeline.类似于logstash的filter。</p>
<h3 id="Filebeats-Module"><a href="#Filebeats-Module" class="headerlink" title="Filebeats Module"></a>Filebeats Module</h3><p>filebeats提供了许多开箱即用的module用于数据采集-&gt;ES建模-&gt;数据处理-&gt;存储并分析数据的一整套解决方案。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">filebeat modules list</span><br><span class="line">filebeat modules <span class="built_in">enable</span> nginx</span><br></pre></td></tr></table></figure>

<p>参见安装目录下的<code>modules</code>目录和<code>fields.yml</code>。按照这个规则可以制定属于我们自己的module。</p>
<h2 id="Metrics-Beats"><a href="#Metrics-Beats" class="headerlink" title="Metrics Beats"></a>Metrics Beats</h2><p>定期收集OS，软件或者服务的指标数据存储在ES中进行实时分析。</p>
<ul>
<li>Logs:记录离散的事件，具有随机性。例如程序的调试信息或者错误信息</li>
<li>Metrics:记录度量可以聚合的数据，具有计划性。例如服务的响应时间</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./metricbeat -e -d <span class="string">&quot;publish&quot;</span></span><br><span class="line">./metricbeat setup --dashboards <span class="comment"># 导入dashboard</span></span><br></pre></td></tr></table></figure>

<p>metricsbeats同filebeats也会向es中导入index template。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET _template/metricbeat*</span><br><span class="line">GET metricbeat-6.1.1-2019.01.05/_search</span><br></pre></td></tr></table></figure>

<p>也可以在kibana的discover中替代上面的命令行进行操作,dashboard面板用于展示指标的监控数据。</p>
<h2 id="Packet-Beats"><a href="#Packet-Beats" class="headerlink" title="Packet Beats"></a>Packet Beats</h2><p>抓取并解析网络包数据。packetbeats抓包配置有2种：</p>
<ul>
<li>pcap:基于libcap，跨平台</li>
<li>af_packet：仅支持Linux，基于内存映射的嗅探技术，性能更好</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">./packetbeat setup --dashboards</span><br><span class="line"><span class="built_in">sudo</span> ./packetbeat -e -c packetbeat.yml -d <span class="string">&quot;publish&quot;</span></span><br><span class="line"></span><br><span class="line">GET _template/packetbeat*</span><br><span class="line">GET packetbeat-6.0.1-2019.01.10/_search</span><br></pre></td></tr></table></figure>

<p>heartbeats用于检测主机是否存活。此外还有<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/beats/libbeat/current/community-beats.html">社区提供的beats</a>可以满足需各种求。</p>
<h1 id="Kibana"><a href="#Kibana" class="headerlink" title="Kibana"></a>Kibana</h1><p>线上部署推荐专门部署一个Coordinating Only ES Node和Kibana在同一台机器上。</p>
<p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/kibana/6.1/tutorial-load-dataset.html">测试数据导入</a></p>
<p>在Kibana的management界面中创建一个名为<code>logstash-*</code>的index pattern。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-cdn-bmnleumcou.cn-shenzhen.fcapp.run/?a=images/kibana-visualize.png" alt="Kibana可视化"><br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-cdn-bmnleumcou.cn-shenzhen.fcapp.run/?a=images/kibana-visualize2.png" alt="Buckets-SplitSeries使用Terms aggression"><br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-cdn-bmnleumcou.cn-shenzhen.fcapp.run/?a=images/kibana-split-chart.png" alt="Buckets-SplitCharts使用不同的图表展示不同的数据"></p>
<p>注意Buckets中聚合的顺序不同将影响展示的结果。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-cdn-bmnleumcou.cn-shenzhen.fcapp.run/?a=images/kibana-timelion.png" alt="时间序列图"></p>
<h1 id="项目实战"><a href="#项目实战" class="headerlink" title="项目实战"></a>项目实战</h1><h2 id="房屋搜索项目"><a href="#房屋搜索项目" class="headerlink" title="房屋搜索项目"></a>房屋搜索项目</h2><p><a target="_blank" rel="noopener" href="https://blog-cdn-bmnleumcou.cn-shenzhen.fcapp.run/?a=media/airbnb.csv">数据源airbnb.csv</a></p>
<h3 id="创建数据模型"><a href="#创建数据模型" class="headerlink" title="创建数据模型"></a>创建数据模型</h3><p><a target="_blank" rel="noopener" href="https://blog-cdn-bmnleumcou.cn-shenzhen.fcapp.run/?a=media/airbnb-settings.json">airbnb.settings.json</a></p>
<h3 id="导入数据"><a href="#导入数据" class="headerlink" title="导入数据"></a>导入数据</h3><p>logstash配置文件<code>ls.conf</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">input<span class="punctuation">&#123;</span></span><br><span class="line">    stdin<span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">filter<span class="punctuation">&#123;</span></span><br><span class="line">    csv<span class="punctuation">&#123;</span></span><br><span class="line">        columns =&gt; <span class="punctuation">[</span><span class="string">&quot;accommodates&quot;</span><span class="punctuation">,</span><span class="string">&quot;bathrooms&quot;</span><span class="punctuation">,</span><span class="string">&quot;bed_type&quot;</span><span class="punctuation">,</span><span class="string">&quot;bedrooms&quot;</span><span class="punctuation">,</span><span class="string">&quot;beds&quot;</span><span class="punctuation">,</span><span class="string">&quot;date_from&quot;</span><span class="punctuation">,</span><span class="string">&quot;date_o&quot;</span><span class="punctuation">,</span><span class="string">&quot;date_rom&quot;</span><span class="punctuation">,</span><span class="string">&quot;date_to&quot;</span><span class="punctuation">,</span><span class="string">&quot;has_availability&quot;</span><span class="punctuation">,</span><span class="string">&quot;host_image&quot;</span><span class="punctuation">,</span><span class="string">&quot;host_name&quot;</span><span class="punctuation">,</span><span class="string">&quot;image&quot;</span><span class="punctuation">,</span><span class="string">&quot;listing_url&quot;</span><span class="punctuation">,</span><span class="string">&quot;location&quot;</span><span class="punctuation">,</span><span class="string">&quot;name&quot;</span><span class="punctuation">,</span><span class="string">&quot;price&quot;</span><span class="punctuation">,</span><span class="string">&quot;property_type&quot;</span><span class="punctuation">,</span><span class="string">&quot;room_type&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">    mutate<span class="punctuation">&#123;</span></span><br><span class="line">        remove_field=&gt;<span class="punctuation">[</span><span class="string">&quot;message&quot;</span><span class="punctuation">]</span></span><br><span class="line">        lowercase=&gt;<span class="punctuation">[</span><span class="string">&quot;has_availability&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">output<span class="punctuation">&#123;</span></span><br><span class="line">    elasticsearch<span class="punctuation">&#123;</span></span><br><span class="line">        index =&gt; <span class="string">&quot;testairbnb&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">    stdout<span class="punctuation">&#123;</span></span><br><span class="line">        codec=&gt;rubydebug</span><br><span class="line"></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>导入：</p>
<p>cat airbnb.csv | bin&#x2F;logstash -f ls.conf</p>
<h3 id="配置Kibana"><a href="#配置Kibana" class="headerlink" title="配置Kibana"></a>配置Kibana</h3><ol>
<li>Management-&gt;Index Patterns-&gt;Create Index Pattern创建一个<code>testairbnb</code>的index pattern，Time Filter field name选择<code>I don&#39;t want to use the Time Filter</code>。</li>
<li>修改host_image,image和listing_url的format为Url，并且将host_image,image的Type配置为<code>Image</code>，Url Template配置为<code>&#123;&#123;rawValue&#125;&#125;</code>,配置成<code>&#123;&#123;value&#125;&#125;</code>会被转义。</li>
<li>接下来就可以在Discover中发现testairbnb了，由于我们没有选择time_filter，所以右上角不会出现时间选择。步骤2中修改的URL和图片也会在这个面板被正确展示出来。</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-cdn-bmnleumcou.cn-shenzhen.fcapp.run/?a=images/test_airbana.png" alt="房屋搜索"></p>
<p><a target="_blank" rel="noopener" href="https://github.com/appbaseio-apps/airbeds">一个更加友好的房屋搜索项目</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/yiifaa/article/details/74531976">注意ES跨域访问</a></p>
<h2 id="nginx日志分析"><a href="#nginx日志分析" class="headerlink" title="nginx日志分析"></a>nginx日志分析</h2><p>资料下载：</p>
<p><a target="_blank" rel="noopener" href="https://blog-cdn-bmnleumcou.cn-shenzhen.fcapp.run/?a=media/nginx_template.json">nginx_template.json</a><br><a target="_blank" rel="noopener" href="https://blog-cdn-bmnleumcou.cn-shenzhen.fcapp.run/?a=media/access-1w.log">access.1w.log</a><br><a target="_blank" rel="noopener" href="https://blog-cdn-bmnleumcou.cn-shenzhen.fcapp.run/?a=media/nginx_log.conf">nginx_log.conf</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/logstash -f nginx_log.conf</span><br></pre></td></tr></table></figure>

<p>导入数据后可以使用<code>GET _cat/indices/nginx_logs_*</code>查看创建的索引，在kinana中配置<code>nginx_logs*</code>index pattern。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-cdn-bmnleumcou.cn-shenzhen.fcapp.run/?a=images/Project-imooc-log-imooc_overview.png" alt="nginx日志分析结果"></p>
<h2 id="北京空气质量分析"><a href="#北京空气质量分析" class="headerlink" title="北京空气质量分析"></a>北京空气质量分析</h2><p><a target="_blank" rel="noopener" href="https://blog-cdn-bmnleumcou.cn-shenzhen.fcapp.run/?a=media/air_quality_mapping_pipeline.json">air_quality_index.json</a><br><a target="_blank" rel="noopener" href="https://blog-cdn-bmnleumcou.cn-shenzhen.fcapp.run/?a=media/filebeat-air_quality.yml">air_quality_filebeat.yml</a></p>
<p>空气质量的CSV数据可以到<a target="_blank" rel="noopener" href="http://www.stateair.net/web/historical/1/1.html">美大使馆网站</a>下载</p>
<p>导入数据：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> air_quality/*.csv | ./filebeat -e -c filebeat-air_quality.yml -d <span class="string">&quot;publish&quot;</span></span><br></pre></td></tr></table></figure>

<p>使用Python脚本将小时数据聚合成天数据：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> elasticsearch <span class="keyword">import</span> Elasticsearch</span><br><span class="line"> </span><br><span class="line">es = Elasticsearch([<span class="string">&#x27;127.0.0.1:9200&#x27;</span>])</span><br><span class="line"> </span><br><span class="line">search_query = &#123;</span><br><span class="line">    <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;range&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;value&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;gte&quot;</span>: <span class="number">1</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;days&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;date_histogram&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;field&quot;</span>: <span class="string">&quot;@timestamp&quot;</span>,</span><br><span class="line">                <span class="string">&quot;interval&quot;</span>: <span class="string">&quot;day&quot;</span>,</span><br><span class="line">                <span class="string">&quot;time_zone&quot;</span>: <span class="string">&quot;+08:00&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;pm25&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;stats&quot;</span>: &#123;</span><br><span class="line">                        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;value&quot;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;size&quot;</span>: <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line">res = es.search(index=<span class="string">&#x27;air_quality&#x27;</span>, body=search_query)</span><br><span class="line"></span><br><span class="line">index_name = <span class="string">&#x27;air_quality_days&#x27;</span></span><br><span class="line">index_type = <span class="string">&#x27;doc&#x27;</span></span><br><span class="line">es.indices.delete(index=index_name, ignore=[<span class="number">400</span>, <span class="number">404</span>])</span><br><span class="line"> </span><br><span class="line"><span class="keyword">for</span> info <span class="keyword">in</span> res[<span class="string">&#x27;aggregations&#x27;</span>][<span class="string">&#x27;days&#x27;</span>][<span class="string">&#x27;buckets&#x27;</span>]:</span><br><span class="line">    cur_date = datetime.strptime(info[<span class="string">&#x27;key_as_string&#x27;</span>], <span class="string">&#x27;%Y-%m-%dT%H:%M:%S.%f+08:00&#x27;</span>)</span><br><span class="line">    new_doc = &#123;</span><br><span class="line">        <span class="string">&quot;@timestamp&quot;</span>: info[<span class="string">&#x27;key_as_string&#x27;</span>],      </span><br><span class="line">        <span class="string">&#x27;year&#x27;</span>: cur_date.year,</span><br><span class="line">        <span class="string">&#x27;month&#x27;</span>: cur_date.month,</span><br><span class="line">        <span class="string">&#x27;day&#x27;</span>: cur_date.day,</span><br><span class="line">        <span class="string">&quot;value_max&quot;</span>: info[<span class="string">&#x27;pm25&#x27;</span>][<span class="string">&#x27;max&#x27;</span>],</span><br><span class="line">        <span class="string">&quot;value_avg&quot;</span>: info[<span class="string">&#x27;pm25&#x27;</span>][<span class="string">&#x27;avg&#x27;</span>],</span><br><span class="line">        <span class="string">&quot;value_min&quot;</span>: info[<span class="string">&#x27;pm25&#x27;</span>][<span class="string">&#x27;min&#x27;</span>],</span><br><span class="line">    &#125;</span><br><span class="line">    es.index(index=index_name, doc_type=index_type, <span class="built_in">id</span>=new_doc[<span class="string">&#x27;@timestamp&#x27;</span>], body=new_doc)</span><br><span class="line">    <span class="built_in">print</span>(new_doc)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>对于在es中没有的字段，可以在kibana的index pattern中的script fields中添加</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-cdn-bmnleumcou.cn-shenzhen.fcapp.run/?a=images/Project-2016-beijing-wumai.png" alt="2016年的北京雾霾"><br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-cdn-bmnleumcou.cn-shenzhen.fcapp.run/?a=images/Project-beijing-air-condition-change.png" alt="北京空气质量趋势"></p>
<h1 id="常用工具"><a href="#常用工具" class="headerlink" title="常用工具"></a>常用工具</h1><ul>
<li>正则调试网站 debuggex，regexr</li>
<li>grok调试：<a target="_blank" rel="noopener" href="https://grokdebug.herokuapp.com/">https://grokdebug.herokuapp.com</a></li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://consoles.fun">consoles</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://consoles.fun/2018/12/10/elk/">https://consoles.fun/2018/12/10/elk/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://consoles.fun" target="_blank">雨碎江南</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/">大数据</a><a class="post-meta__tags" href="/tags/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">数据分析</a></div><div class="post-share"><div class="social-share" data-image="/img/butterfly-icon.png" data-sites="wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/butterfly-extsrc/1.1.4/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdnjs.cloudflare.com/ajax/libs/butterfly-extsrc/1.1.4/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/butterfly-icon.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">consoles</div><div class="author-info-description">野马也，尘埃也，生物之以息相吹也</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">101</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">77</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">13</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/consoles"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/consoles" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:consoles.me@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E6%9C%AF%E8%AF%AD"><span class="toc-number">1.</span> <span class="toc-text">常见术语</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%8D%E5%90%91%E7%B4%A2%E5%BC%95%E5%92%8C%E5%88%86%E8%AF%8D"><span class="toc-number">2.</span> <span class="toc-text">反向索引和分词</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%AD%E6%96%87%E5%88%86%E8%AF%8D%E7%9A%84%E9%9A%BE%E7%82%B9"><span class="toc-number">2.1.</span> <span class="toc-text">中文分词的难点</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Mapping%E8%AE%BE%E7%BD%AE"><span class="toc-number">3.</span> <span class="toc-text">Mapping设置</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Search-API"><span class="toc-number">4.</span> <span class="toc-text">Search API</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#URI-Search"><span class="toc-number">4.1.</span> <span class="toc-text">URI Search</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Query-DSL"><span class="toc-number">4.2.</span> <span class="toc-text">Query DSL</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Match-Query"><span class="toc-number">4.2.1.</span> <span class="toc-text">Match Query</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Term-Terms-Query"><span class="toc-number">4.2.2.</span> <span class="toc-text">Term &amp; Terms Query</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Range-Query"><span class="toc-number">4.2.3.</span> <span class="toc-text">Range Query</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Bool-Query"><span class="toc-number">4.2.4.</span> <span class="toc-text">Bool Query</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E7%89%B9%E6%80%A7"><span class="toc-number">5.</span> <span class="toc-text">分布式特性</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%AF%E6%9C%AC%E5%92%8C%E5%88%86%E7%89%87"><span class="toc-number">5.1.</span> <span class="toc-text">副本和分片</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Cluster-Health-%E6%95%85%E9%9A%9C%E8%BD%AC%E7%A7%BB"><span class="toc-number">5.2.</span> <span class="toc-text">Cluster Health &amp; 故障转移</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E6%A1%A3%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8"><span class="toc-number">5.3.</span> <span class="toc-text">文档分布式存储</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%84%91%E8%A3%82%E9%97%AE%E9%A2%98"><span class="toc-number">5.4.</span> <span class="toc-text">脑裂问题</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ES%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6"><span class="toc-number">6.</span> <span class="toc-text">ES运行机制</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Query-Then-Fetch"><span class="toc-number">6.1.</span> <span class="toc-text">Query Then Fetch</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E6%80%A7%E7%AE%97%E5%88%86"><span class="toc-number">6.2.</span> <span class="toc-text">相关性算分</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E9%A1%B5%E5%92%8C%E9%81%8D%E5%8E%86"><span class="toc-number">6.3.</span> <span class="toc-text">分页和遍历</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%81%9A%E5%90%88%E5%88%86%E6%9E%90"><span class="toc-number">7.</span> <span class="toc-text">聚合分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Bucket%E8%81%9A%E5%90%88"><span class="toc-number">7.1.</span> <span class="toc-text">Bucket聚合</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Metric%E8%81%9A%E5%90%88"><span class="toc-number">7.2.</span> <span class="toc-text">Metric聚合</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Bucket%E5%92%8CMetric%E8%81%9A%E5%90%88%E5%88%86%E6%9E%90"><span class="toc-number">7.3.</span> <span class="toc-text">Bucket和Metric聚合分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%9C%E7%94%A8%E8%8C%83%E5%9B%B4"><span class="toc-number">7.4.</span> <span class="toc-text">作用范围</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%92%E5%BA%8F%E4%BB%A5%E5%8F%8A%E7%B2%BE%E5%87%86%E5%BA%A6"><span class="toc-number">7.5.</span> <span class="toc-text">排序以及精准度</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BB%BA%E6%A8%A1"><span class="toc-number">8.</span> <span class="toc-text">数据建模</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B3%E8%81%94%E5%85%B3%E7%B3%BB%E5%A4%84%E7%90%86"><span class="toc-number">8.1.</span> <span class="toc-text">关联关系处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reindex"><span class="toc-number">8.2.</span> <span class="toc-text">Reindex</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E8%B0%83%E4%BC%98"><span class="toc-number">9.</span> <span class="toc-text">集群调优</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#JVM%E8%AE%BE%E5%AE%9A"><span class="toc-number">9.1.</span> <span class="toc-text">JVM设定</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%99%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="toc-number">9.2.</span> <span class="toc-text">写性能优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%BB%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="toc-number">9.3.</span> <span class="toc-text">读性能优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E8%AE%BE%E5%AE%9AShard%E6%95%B0"><span class="toc-number">9.4.</span> <span class="toc-text">如何设定Shard数</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#LogStash"><span class="toc-number">10.</span> <span class="toc-text">LogStash</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%A5%E9%97%A8-%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6"><span class="toc-number">10.1.</span> <span class="toc-text">入门 &amp; 运行机制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-number">10.2.</span> <span class="toc-text">线程分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Queue"><span class="toc-number">10.2.1.</span> <span class="toc-text">Queue</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B"><span class="toc-number">10.2.2.</span> <span class="toc-text">线程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8F%92%E4%BB%B6"><span class="toc-number">10.3.</span> <span class="toc-text">插件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Input"><span class="toc-number">10.3.1.</span> <span class="toc-text">Input</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Filter"><span class="toc-number">10.3.2.</span> <span class="toc-text">Filter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E9%85%8D%E7%BD%AE%E5%BB%BA%E8%AE%AE"><span class="toc-number">10.3.3.</span> <span class="toc-text">调试配置建议</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E6%88%98apache%E6%97%A5%E5%BF%97"><span class="toc-number">10.4.</span> <span class="toc-text">实战apache日志</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E6%88%98CSV%E6%96%87%E4%BB%B6"><span class="toc-number">10.5.</span> <span class="toc-text">实战CSV文件</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Beats"><span class="toc-number">11.</span> <span class="toc-text">Beats</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Filebeat"><span class="toc-number">11.1.</span> <span class="toc-text">Filebeat</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Elasticsearch-Ingest-Node"><span class="toc-number">11.1.1.</span> <span class="toc-text">Elasticsearch Ingest Node</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Filebeats-Module"><span class="toc-number">11.1.2.</span> <span class="toc-text">Filebeats Module</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Metrics-Beats"><span class="toc-number">11.2.</span> <span class="toc-text">Metrics Beats</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Packet-Beats"><span class="toc-number">11.3.</span> <span class="toc-text">Packet Beats</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Kibana"><span class="toc-number">12.</span> <span class="toc-text">Kibana</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98"><span class="toc-number">13.</span> <span class="toc-text">项目实战</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%88%BF%E5%B1%8B%E6%90%9C%E7%B4%A2%E9%A1%B9%E7%9B%AE"><span class="toc-number">13.1.</span> <span class="toc-text">房屋搜索项目</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B"><span class="toc-number">13.1.1.</span> <span class="toc-text">创建数据模型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE"><span class="toc-number">13.1.2.</span> <span class="toc-text">导入数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEKibana"><span class="toc-number">13.1.3.</span> <span class="toc-text">配置Kibana</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#nginx%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90"><span class="toc-number">13.2.</span> <span class="toc-text">nginx日志分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8C%97%E4%BA%AC%E7%A9%BA%E6%B0%94%E8%B4%A8%E9%87%8F%E5%88%86%E6%9E%90"><span class="toc-number">13.3.</span> <span class="toc-text">北京空气质量分析</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7"><span class="toc-number">14.</span> <span class="toc-text">常用工具</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/04/30/%E7%AE%A1%E7%90%86%E5%AD%A6/" title="管理学">管理学</a><time datetime="2025-07-09T23:24:02.000Z" title="更新于 2025-07-09 23:24:02">2025-07-09</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2020/11/05/%E7%A0%81%E5%86%9C%E7%BF%BB%E8%BA%AB%E6%9C%89%E6%84%9F/" title="码农翻身有感">码农翻身有感</a><time datetime="2025-07-04T23:02:12.000Z" title="更新于 2025-07-04 23:02:12">2025-07-04</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2019/08/22/%E9%9D%A2%E8%AF%95%E5%B8%B8%E7%94%A8%E5%A5%97%E8%B7%AF/" title="面试常用套路">面试常用套路</a><time datetime="2025-07-02T18:34:21.000Z" title="更新于 2025-07-02 18:34:21">2025-07-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2016/10/18/memcached/" title="memcached 初窥">memcached 初窥</a><time datetime="2025-07-02T11:15:01.000Z" title="更新于 2025-07-02 11:15:01">2025-07-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2020/05/09/%E4%B8%80%E4%BA%9B%E6%83%B3%E8%AF%BB%E7%9A%84%E4%B9%A6/" title="一些想读的书">一些想读的书</a><time datetime="2025-06-28T22:18:10.000Z" title="更新于 2025-06-28 22:18:10">2025-06-28</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2016 - 2025 By consoles</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">日拱一卒，功不唐捐</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.36/fancybox/fancybox.umd.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/instant.page/5.2.0/instantpage.min.js" type="module"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/19.1.3/lazyload.iife.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/node-snackbar/0.1.16/snackbar.min.js"></script><div class="js-pjax"></div><script defer="defer" id="ribbon" src="https://cdnjs.cloudflare.com/ajax/libs/butterfly-extsrc/1.1.4/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="true" data-click="true"></script><script id="click-heart" src="https://cdnjs.cloudflare.com/ajax/libs/butterfly-extsrc/1.1.4/click-heart.min.js" async="async" mobile="false"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/pjax/0.2.8/pjax.min.js"></script><script>(() => {
  const pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

  window.pjax = new Pjax({
    elements: 'a:not([target="_blank"])',
    selectors: pjaxSelectors,
    cacheBust: false,
    analytics: false,
    scrollRestoration: false
  })

  const triggerPjaxFn = (val) => {
    if (!val) return
    Object.values(val).forEach(fn => fn())
  }

  document.addEventListener('pjax:send', () => {
    // removeEventListener
    btf.removeGlobalFnEvent('pjaxSendOnce')
    btf.removeGlobalFnEvent('themeChange')

    // reset readmode
    const $bodyClassList = document.body.classList
    if ($bodyClassList.contains('read-mode')) $bodyClassList.remove('read-mode')

    triggerPjaxFn(window.globalFn.pjaxSend)
  })

  document.addEventListener('pjax:complete', () => {
    btf.removeGlobalFnEvent('pjaxCompleteOnce')
    document.querySelectorAll('script[data-pjax]').forEach(item => {
      const newScript = document.createElement('script')
      const content = item.text || item.textContent || item.innerHTML || ""
      Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
      newScript.appendChild(document.createTextNode(content))
      item.parentNode.replaceChild(newScript, item)
    })

    triggerPjaxFn(window.globalFn.pjaxComplete)
  })

  document.addEventListener('pjax:error', e => {
    if (e.request.status === 404) {
      pjax.loadUrl('/404.html')
    }
  })
})()</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>